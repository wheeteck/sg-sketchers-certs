<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Singapore Sketchers Certification System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-details {
            text-align: right;
        }
        
        .user-details .name {
            font-weight: bold;
            font-size: 14px;
        }
        
        .user-details .role {
            font-size: 12px;
            opacity: 0.9;
        }
        
        /* Layout with Sidebar */
        .main-layout {
            display: flex;
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Sidebar Navigation */
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            padding: 20px 0;
        }
        
        .nav-item {
            display: block;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover {
            background: #f7f7f7;
            border-left-color: #667eea;
        }
        
        .nav-item.active {
            background: #f0f4ff;
            border-left-color: #667eea;
            color: #667eea;
            font-weight: 500;
        }
        
        .nav-section-title {
            padding: 10px 20px;
            font-size: 11px;
            text-transform: uppercase;
            color: #999;
            letter-spacing: 1px;
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        
        .nav-section-title:first-child {
            margin-top: 0;
            border-top: none;
            padding-top: 10px;
        }
        
        /* Main Content Area */
        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* Page Headers */
        .page-header {
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .page-subtitle {
            color: #666;
            font-size: 14px;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-size: 13px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Buttons */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .btn-danger {
            background: #e53e3e;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            font-size: 14px;
        }
        
        tr:hover {
            background: #f9f9f9;
        }
        
        /* Search Bar */
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            max-width: 400px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .badge-warning {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .badge-info {
            background: #bee3f8;
            color: #2c5282;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        /* Auth Container */
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .divider {
            text-align: center;
            margin: 20px 0;
            color: #666;
            position: relative;
        }
        
        .divider::before, .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background: #ddd;
        }
        
        .divider::before {
            left: 0;
        }
        
        .divider::after {
            right: 0;
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        .mb-0 {
            margin-bottom: 0;
        }
        
        .mt-3 {
            margin-top: 30px;
        }
        
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        /* Certificate Types Specific */
        .cert-type-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .cert-type-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .cert-type-name {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }
        
        .cert-type-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 13px;
            color: #666;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #eee;
            }
            
            .content {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1>🎨 Singapore Sketchers Certification System</h1>
            <div id="headerUserInfo" class="user-info hidden">
                <div class="user-details">
                    <div class="name" id="headerUserName">Loading...</div>
                    <div class="role" id="headerUserRole">Loading...</div>
                </div>
                <button class="btn-danger btn-sm" onclick="signOut()">Sign Out</button>
            </div>
        </div>
    </header>

    <!-- Auth View -->
    <div id="authView" class="hidden">
        <div class="auth-container">
            <h2 style="text-align: center; margin-bottom: 20px;">Sign In</h2>
            
            <button class="btn-primary" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;" onclick="signInWithGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" height="18">
                Sign in with Google
            </button>
            
            <div class="divider">OR</div>
            
            <form id="emailSignInForm" onsubmit="signInWithEmail(event)">
                <div class="form-group">
                    <input type="email" id="signInEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="signInPassword" placeholder="Password" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Sign In</button>
            </form>
            
            <div id="authMessage" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <div class="main-layout">
            <!-- Sidebar Navigation -->
            <nav class="sidebar" id="sidebarNav">
                <!-- Navigation will be populated based on user role -->
            </nav>

            <!-- Content Area -->
            <main class="content">
                <!-- Dashboard Page -->
                <div id="page-dashboard" class="page active">
                    <div class="page-header">
                        <h2 class="page-title">Dashboard</h2>
                        <p class="page-subtitle">System overview and statistics</p>
                    </div>
                    
                    <div class="stats-grid" id="dashboardStats">
                        <!-- Stats will be loaded here -->
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Activity</h3>
                        </div>
                        <div id="recentActivity">
                            <p>Loading recent certificates...</p>
                        </div>
                    </div>
                </div>

                <!-- Certificate Types Page (Super Admin) -->
                <div id="page-cert-types" class="page">
                    <div class="page-header">
                        <h2 class="page-title">Certificate Types</h2>
                        <p class="page-subtitle">Manage certificate templates and configurations</p>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Add New Certificate Type</h3>
                            <button class="btn-primary btn-sm" onclick="toggleCertTypeForm()">+ New Type</button>
                        </div>
                        
                        <form id="certTypeForm" class="hidden" onsubmit="saveCertificateType(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Type Name *</label>
                                    <input type="text" id="typeName" required placeholder="e.g., Training - Advanced">
                                </div>
                                <div class="form-group">
                                    <label>Category *</label>
                                    <select id="typeCategory" required>
                                        <option value="">Select Category</option>
                                        <option value="committee">Committee</option>
                                        <option value="training">Training</option>
                                        <option value="trainer">Trainer</option>
                                        <option value="volunteer">Volunteer</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Default CPD Hours</label>
                                    <input type="text" id="typeHours" placeholder="e.g., 8 or NA">
                                </div>
                                <div class="form-group">
                                    <label>Valid Duration (months)</label>
                                    <input type="number" id="typeDuration" placeholder="e.g., 12 for 1 year">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Achievement Text Template</label>
                                <textarea id="typeAchievement" placeholder="e.g., has successfully completed the {title} program..."></textarea>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Prerequisites (for Trainer types)</label>
                                    <input type="text" id="typePrerequisites" placeholder="e.g., Must have Advanced certification">
                                </div>
                                <div class="form-group">
                                    <label>Status</label>
                                    <select id="typeStatus">
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                            
                            <input type="hidden" id="typeId">
                            <div class="btn-group">
                                <button type="submit" class="btn-primary">Save Certificate Type</button>
                                <button type="button" class="btn-secondary" onclick="cancelCertTypeForm()">Cancel</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Existing Certificate Types</h3>
                        </div>
                        <div id="certTypesList">
                            <p>Loading certificate types...</p>
                        </div>
                    </div>
                </div>

                <!-- User Management Page -->
                <div id="page-users" class="page">
                    <div class="page-header">
                        <h2 class="page-title">User Management</h2>
                        <p class="page-subtitle">Manage users and their roles</p>
                    </div>
                    
                    <div class="card">
                        <div class="search-bar">
                            <input type="text" class="search-input" id="userSearch" placeholder="Search by name or email..." onkeyup="filterUsers()">
                            <button class="btn-secondary" onclick="loadUsers()">Refresh</button>
                        </div>
                        
                        <div class="table-container">
                            <table id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Joined</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">Loading users...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Issue Certificate Page -->
                <div id="page-issue-cert" class="page">
                    <div class="page-header">
                        <h2 class="page-title">Issue Certificate</h2>
                        <p class="page-subtitle">Create a new certificate for a participant</p>
                    </div>
                    
                    <div class="card">
                        <form id="issueCertForm" onsubmit="issueCertificate(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Recipient Email *</label>
                                    <input type="email" id="certRecipientEmail" required list="userEmails">
                                    <datalist id="userEmails"></datalist>
                                </div>
                                <div class="form-group">
                                    <label>Certificate Type *</label>
                                    <select id="certType" required onchange="updateCertFields()">
                                        <option value="">Select Type</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Course/Role/Event Title *</label>
                                    <input type="text" id="certTitle" required placeholder="e.g., Urban Sketching Workshop">
                                </div>
                                <div class="form-group">
                                    <label>CPD Hours</label>
                                    <input type="text" id="certHours" placeholder="e.g., 8 or NA">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Instructor Name (if applicable)</label>
                                <input type="text" id="certInstructor" placeholder="Leave blank if not applicable">
                            </div>
                            
                            <div class="form-group">
                                <label>Additional Notes</label>
                                <textarea id="certNotes" placeholder="Any special notes about this certificate"></textarea>
                            </div>
                            
                            <button type="submit" class="btn-primary">Issue Certificate</button>
                        </form>
                        
                        <div id="certMessage" style="margin-top: 15px;"></div>
                    </div>
                </div>

                <!-- All Certificates Page -->
                <div id="page-all-certs" class="page">
                    <div class="page-header">
                        <h2 class="page-title">All Certificates</h2>
                        <p class="page-subtitle">View and manage all issued certificates</p>
                    </div>
                    
                    <div class="card">
                        <div class="search-bar">
                            <input type="text" class="search-input" id="certSearch" placeholder="Search by certificate number, recipient, or title..." onkeyup="filterCertificates()">
                            <select id="certFilter" onchange="filterCertificates()">
                                <option value="">All Types</option>
                            </select>
                            <button class="btn-secondary" onclick="loadAllCertificates()">Refresh</button>
                        </div>
                        
                        <div class="table-container">
                            <table id="certificatesTable">
                                <thead>
                                    <tr>
                                        <th>Certificate #</th>
                                        <th>Recipient</th>
                                        <th>Type</th>
                                        <th>Title</th>
                                        <th>Issued Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="certificatesTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">Loading certificates...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- My Certificates Page (Participants) -->
                <div id="page-my-certs" class="page">
                    <div class="page-header">
                        <h2 class="page-title">My Certificates</h2>
                        <p class="page-subtitle">View and download your certificates</p>
                    </div>
                    
                    <div id="myCertificatesList">
                        <p>Loading your certificates...</p>
                    </div>
                </div>

                <!-- System Settings Page -->
                <div id="page-settings" class="page">
                    <div class="page-header">
                        <h2 class="page-title">System Settings</h2>
                        <p class="page-subtitle">Configure system-wide settings</p>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Organization Details</h3>
                        </div>
                        <form id="settingsForm" onsubmit="saveSettings(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Organization Name</label>
                                    <input type="text" id="orgName" value="Singapore Sketchers">
                                </div>
                                <div class="form-group">
                                    <label>President Name</label>
                                    <input type="text" id="presidentName">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Certificate Prefix</label>
                                    <input type="text" id="certPrefix" value="SGS">
                                </div>
                                <div class="form-group">
                                    <label>Current Year</label>
                                    <input type="number" id="currentYear">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Logo (Base64)</label>
                                <textarea id="logoBase64" placeholder="data:image/png;base64,..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn-primary">Save Settings</button>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Edit User Role Modal -->
    <div id="roleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit User Role</h2>
                <button class="close-btn" onclick="closeRoleModal()">&times;</button>
            </div>
            <form id="roleForm" onsubmit="updateUserRole(event)">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>User Email</label>
                    <input type="text" id="editUserEmail" readonly>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="editUserRole" required>
                        <option value="participant">Participant</option>
                        <option value="admin">Admin</option>
                        <option value="superadmin">Super Admin</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Update Role</button>
            </form>
        </div>
    </div>

    <!-- Load html2canvas for certificate download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            signInWithPopup,
            signInWithEmailAndPassword,
            GoogleAuthProvider,
            onAuthStateChanged,
            signOut as firebaseSignOut
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            getDoc,
            getDocs,
            setDoc,
            updateDoc,
            deleteDoc,
            collection,
            addDoc,
            query,
            where,
            orderBy,
            limit,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBsSi4gFWV8VX9kuq0mJmHtTgnR0VXyQ4k",
            authDomain: "sg-sketchers-certs.firebaseapp.com",
            projectId: "sg-sketchers-certs",
            storageBucket: "sg-sketchers-certs.firebasestorage.app",
            messagingSenderId: "506191422278",
            appId: "1:506191422278:web:55bc1d0ff90a966285bb47"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // Global variables
        let currentUser = null;
        let currentUserProfile = null;
        let systemSettings = null;
        let certificateTypes = [];
        let allUsers = [];
        let allCertificates = [];

        // Navigation Management
        function initializeNavigation(role) {
            const nav = document.getElementById('sidebarNav');
            let navHTML = '';
            
            if (role === 'superadmin') {
                navHTML = `
                    <div class="nav-section-title">Main</div>
                    <a class="nav-item active" onclick="navigateTo('dashboard')">Dashboard</a>
                    <a class="nav-item" onclick="navigateTo('cert-types')">Certificate Types</a>
                    <a class="nav-item" onclick="navigateTo('users')">User Management</a>
                    <a class="nav-item" onclick="navigateTo('issue-cert')">Issue Certificate</a>
                    <a class="nav-item" onclick="navigateTo('all-certs')">All Certificates</a>
                    <div class="nav-section-title">System</div>
                    <a class="nav-item" onclick="navigateTo('settings')">Settings</a>
                `;
            } else if (role === 'admin') {
                navHTML = `
                    <div class="nav-section-title">Main</div>
                    <a class="nav-item active" onclick="navigateTo('dashboard')">Dashboard</a>
                    <a class="nav-item" onclick="navigateTo('issue-cert')">Issue Certificate</a>
                    <a class="nav-item" onclick="navigateTo('all-certs')">All Certificates</a>
                `;
            } else {
                navHTML = `
                    <div class="nav-section-title">Main</div>
                    <a class="nav-item active" onclick="navigateTo('my-certs')">My Certificates</a>
                `;
            }
            
            nav.innerHTML = navHTML;
        }

        window.navigateTo = (page) => {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            // Show selected page
            document.getElementById(`page-${page}`).classList.add('active');
            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            
            // Load page-specific data
            switch(page) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'cert-types':
                    loadCertificateTypes();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'issue-cert':
                    loadIssueCertPage();
                    break;
                case 'all-certs':
                    loadAllCertificates();
                    break;
                case 'my-certs':
                    loadMyCertificates();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        };

        // Load System Settings
        async function loadSystemSettings() {
            try {
                const settingsDoc = await getDoc(doc(db, 'systemSettings', 'config'));
                if (settingsDoc.exists()) {
                    systemSettings = settingsDoc.data();
                }
            } catch (error) {
                console.error('Error loading system settings:', error);
            }
        }

        // Certificate Types Management
        window.toggleCertTypeForm = () => {
            document.getElementById('certTypeForm').classList.toggle('hidden');
        };

        window.cancelCertTypeForm = () => {
            document.getElementById('certTypeForm').reset();
            document.getElementById('typeId').value = '';
            document.getElementById('certTypeForm').classList.add('hidden');
        };

        window.saveCertificateType = async (event) => {
            event.preventDefault();
            
            const typeData = {
                name: document.getElementById('typeName').value,
                category: document.getElementById('typeCategory').value,
                defaultHours: document.getElementById('typeHours').value || 'NA',
                validDuration: document.getElementById('typeDuration').value || null,
                achievementText: document.getElementById('typeAchievement').value,
                prerequisites: document.getElementById('typePrerequisites').value,
                status: document.getElementById('typeStatus').value,
                updatedAt: serverTimestamp()
            };
            
            try {
                const typeId = document.getElementById('typeId').value;
                if (typeId) {
                    await updateDoc(doc(db, 'certificateTypes', typeId), typeData);
                    alert('Certificate type updated successfully!');
                } else {
                    typeData.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'certificateTypes'), typeData);
                    alert('Certificate type created successfully!');
                }
                
                cancelCertTypeForm();
                loadCertificateTypes();
            } catch (error) {
                alert('Error saving certificate type: ' + error.message);
            }
        };

        window.editCertType = (id) => {
            const type = certificateTypes.find(t => t.id === id);
            if (type) {
                document.getElementById('typeId').value = id;
                document.getElementById('typeName').value = type.name;
                document.getElementById('typeCategory').value = type.category;
                document.getElementById('typeHours').value = type.defaultHours || '';
                document.getElementById('typeDuration').value = type.validDuration || '';
                document.getElementById('typeAchievement').value = type.achievementText || '';
                document.getElementById('typePrerequisites').value = type.prerequisites || '';
                document.getElementById('typeStatus').value = type.status || 'active';
                document.getElementById('certTypeForm').classList.remove('hidden');
            }
        };

        window.deleteCertType = async (id) => {
            if (confirm('Are you sure you want to delete this certificate type?')) {
                try {
                    await deleteDoc(doc(db, 'certificateTypes', id));
                    alert('Certificate type deleted successfully!');
                    loadCertificateTypes();
                } catch (error) {
                    alert('Error deleting certificate type: ' + error.message);
                }
            }
        };

        async function loadCertificateTypes() {
            try {
                const snapshot = await getDocs(collection(db, 'certificateTypes'));
                certificateTypes = [];
                let html = '';
                
                snapshot.forEach(doc => {
                    const type = { id: doc.id, ...doc.data() };
                    certificateTypes.push(type);
                    
                    html += `
                        <div class="cert-type-item">
                            <div class="cert-type-header">
                                <div class="cert-type-name">${type.name}</div>
                                <div class="btn-group">
                                    <button class="btn-secondary btn-sm" onclick="editCertType('${doc.id}')">Edit</button>
                                    <button class="btn-danger btn-sm" onclick="deleteCertType('${doc.id}')">Delete</button>
                                </div>
                            </div>
                            <div class="cert-type-details">
                                <div><strong>Category:</strong> ${type.category}</div>
                                <div><strong>Default Hours:</strong> ${type.defaultHours}</div>
                                <div><strong>Status:</strong> <span class="badge ${type.status === 'active' ? 'badge-success' : 'badge-warning'}">${type.status}</span></div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('certTypesList').innerHTML = html || '<p>No certificate types found. Create your first one above.</p>';
                
                // Update certificate type dropdowns
                updateCertTypeDropdowns();
                
            } catch (error) {
                console.error('Error loading certificate types:', error);
                document.getElementById('certTypesList').innerHTML = '<p class="alert alert-error">Error loading certificate types</p>';
            }
        }

        function updateCertTypeDropdowns() {
            const select = document.getElementById('certType');
            const filter = document.getElementById('certFilter');
            
            if (select) {
                let options = '<option value="">Select Type</option>';
                certificateTypes.filter(t => t.status === 'active').forEach(type => {
                    options += `<option value="${type.id}" data-category="${type.category}" data-hours="${type.defaultHours}">${type.name}</option>`;
                });
                select.innerHTML = options;
            }
            
            if (filter) {
                let options = '<option value="">All Types</option>';
                certificateTypes.forEach(type => {
                    options += `<option value="${type.name}">${type.name}</option>`;
                });
                filter.innerHTML = options;
            }
        }

        window.updateCertFields = () => {
            const select = document.getElementById('certType');
            const hoursField = document.getElementById('certHours');
            
            if (select.selectedOptions[0]) {
                const hours = select.selectedOptions[0].getAttribute('data-hours');
                if (hours) {
                    hoursField.value = hours;
                }
            }
        };

        // User Management
        async function loadUsers() {
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                allUsers = [];
                let html = '';
                
                snapshot.forEach(doc => {
                    const user = { id: doc.id, ...doc.data() };
                    allUsers.push(user);
                    
                    const createdDate = user.createdAt?.toDate ? user.createdAt.toDate().toLocaleDateString() : 'Unknown';
                    const roleClass = `badge-${user.role === 'superadmin' ? 'warning' : user.role === 'admin' ? 'info' : 'success'}`;
                    
                    html += `
                        <tr>
                            <td>${user.name || 'Unknown'}</td>
                            <td>${user.email}</td>
                            <td><span class="badge ${roleClass}">${user.role || 'participant'}</span></td>
                            <td>${createdDate}</td>
                            <td>
                                <button class="btn-secondary btn-sm" onclick="openRoleModal('${doc.id}', '${user.email}', '${user.role || 'participant'}')">Edit Role</button>
                            </td>
                        </tr>
                    `;
                });
                
                document.getElementById('usersTableBody').innerHTML = html || '<tr><td colspan="5" class="text-center">No users found</td></tr>';
                
                // Update user email datalist
                const datalist = document.getElementById('userEmails');
                if (datalist) {
                    datalist.innerHTML = allUsers.map(u => `<option value="${u.email}">`).join('');
                }
                
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        window.filterUsers = () => {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#usersTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        window.openRoleModal = (userId, email, currentRole) => {
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUserEmail').value = email;
            document.getElementById('editUserRole').value = currentRole;
            document.getElementById('roleModal').classList.add('active');
        };

        window.closeRoleModal = () => {
            document.getElementById('roleModal').classList.remove('active');
        };

        window.updateUserRole = async (event) => {
            event.preventDefault();
            const userId = document.getElementById('editUserId').value;
            const newRole = document.getElementById('editUserRole').value;
            
            try {
                await updateDoc(doc(db, 'users', userId), {
                    role: newRole
                });
                closeRoleModal();
                loadUsers();
                alert('Role updated successfully!');
            } catch (error) {
                alert('Error updating role: ' + error.message);
            }
        };

        // Certificate Management
        async function loadIssueCertPage() {
            await loadCertificateTypes();
            await loadUsers();
        }

        window.issueCertificate = async (event) => {
            event.preventDefault();
            
            try {
                const recipientEmail = document.getElementById('certRecipientEmail').value;
                const certTypeId = document.getElementById('certType').value;
                const certTitle = document.getElementById('certTitle').value;
                const certHours = document.getElementById('certHours').value || 'NA';
                const certInstructor = document.getElementById('certInstructor').value || '';
                const certNotes = document.getElementById('certNotes').value || '';
                
                // Find recipient user
                const recipient = allUsers.find(u => u.email === recipientEmail);
                if (!recipient) {
                    throw new Error('Recipient not found. User must have an account first.');
                }
                
                // Find certificate type
                const certType = certificateTypes.find(t => t.id === certTypeId);
                
                const year = new Date().getFullYear();
                const random = Math.random().toString(36).substring(2, 8).toUpperCase();
                const certNumber = `${systemSettings?.certPrefix || 'SGS'}-${year}-${random}`;
                
                await addDoc(collection(db, 'certificates'), {
                    recipientId: recipient.id,
                    recipientEmail: recipientEmail,
                    recipientName: recipient.name || 'Unknown',
                    certificateNumber: certNumber,
                    type: certType?.name || 'Custom',
                    category: certType?.category || 'other',
                    title: certTitle,
                    hours: certHours,
                    instructor: certInstructor,
                    notes: certNotes,
                    issuedBy: currentUserProfile.name,
                    issuedByEmail: currentUser.email,
                    issuedDate: serverTimestamp(),
                    createdAt: serverTimestamp(),
                    year: year
                });
                
                document.getElementById('certMessage').innerHTML = `<div class="alert alert-success">Certificate issued successfully! Certificate #: ${certNumber}</div>`;
                document.getElementById('issueCertForm').reset();
                
            } catch (error) {
                document.getElementById('certMessage').innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        };

        async function loadAllCertificates() {
            try {
                const q = query(collection(db, 'certificates'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                allCertificates = [];
                let html = '';
                
                snapshot.forEach(doc => {
                    const cert = { id: doc.id, ...doc.data() };
                    allCertificates.push(cert);
                    
                    const date = cert.issuedDate?.toDate ? cert.issuedDate.toDate().toLocaleDateString() : 'Recent';
                    
                    html += `
                        <tr>
                            <td><code>${cert.certificateNumber}</code></td>
                            <td>${cert.recipientName}</td>
                            <td>${cert.type}</td>
                            <td>${cert.title}</td>
                            <td>${date}</td>
                            <td>
                                <button class="btn-primary btn-sm" onclick="viewCertificate('${doc.id}')">View</button>
                            </td>
                        </tr>
                    `;
                });
                
                document.getElementById('certificatesTableBody').innerHTML = html || '<tr><td colspan="6" class="text-center">No certificates found</td></tr>';
                
            } catch (error) {
                console.error('Error loading certificates:', error);
            }
        }

        window.filterCertificates = () => {
            const search = document.getElementById('certSearch').value.toLowerCase();
            const filter = document.getElementById('certFilter').value.toLowerCase();
            const rows = document.querySelectorAll('#certificatesTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const matchesSearch = text.includes(search);
                const matchesFilter = !filter || text.includes(filter);
                row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
            });
        };

        async function loadMyCertificates() {
            try {
                const q = query(
                    collection(db, 'certificates'),
                    where('recipientId', '==', currentUser.uid),
                    orderBy('createdAt', 'desc')
                );
                
                const snapshot = await getDocs(q);
                let html = '';
                
                snapshot.forEach(doc => {
                    const cert = doc.data();
                    const date = cert.issuedDate?.toDate ? cert.issuedDate.toDate().toLocaleDateString() : 'Recent';
                    
                    html += `
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">${cert.title}</h3>
                                <button class="btn-primary btn-sm" onclick="viewCertificate('${doc.id}')">View Certificate</button>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div><strong>Type:</strong> ${cert.type}</div>
                                <div><strong>Hours:</strong> ${cert.hours}</div>
                                <div><strong>Issued:</strong> ${date}</div>
                                <div><strong>Certificate #:</strong> <code>${cert.certificateNumber}</code></div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById('myCertificatesList').innerHTML = html || '<p class="alert alert-error">No certificates found.</p>';
                
            } catch (error) {
                console.error('Error loading certificates:', error);
            }
        }

        // Dashboard
        async function loadDashboard() {
            try {
                // Load stats
                const certsSnapshot = await getDocs(collection(db, 'certificates'));
                const usersSnapshot = await getDocs(collection(db, 'users'));
                
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                let monthCount = 0;
                
                certsSnapshot.forEach(doc => {
                    const cert = doc.data();
                    if (cert.createdAt && cert.createdAt.toDate && cert.createdAt.toDate() >= firstDay) {
                        monthCount++;
                    }
                });
                
                const typesSnapshot = await getDocs(collection(db, 'certificateTypes'));
                
                let statsHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${certsSnapshot.size}</div>
                        <div class="stat-label">Total Certificates</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${usersSnapshot.size}</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${monthCount}</div>
                        <div class="stat-label">This Month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${typesSnapshot.size}</div>
                        <div class="stat-label">Certificate Types</div>
                    </div>
                `;
                
                document.getElementById('dashboardStats').innerHTML = statsHTML;
                
                // Load recent certificates
                const recentQ = query(collection(db, 'certificates'), orderBy('createdAt', 'desc'), limit(5));
                const recentSnapshot = await getDocs(recentQ);
                
                let recentHTML = '<div class="table-container"><table><thead><tr><th>Certificate #</th><th>Recipient</th><th>Type</th><th>Date</th></tr></thead><tbody>';
                
                recentSnapshot.forEach(doc => {
                    const cert = doc.data();
                    const date = cert.issuedDate?.toDate ? cert.issuedDate.toDate().toLocaleDateString() : 'Recent';
                    recentHTML += `
                        <tr>
                            <td><code>${cert.certificateNumber}</code></td>
                            <td>${cert.recipientName}</td>
                            <td>${cert.type}</td>
                            <td>${date}</td>
                        </tr>
                    `;
                });
                
                recentHTML += '</tbody></table></div>';
                document.getElementById('recentActivity').innerHTML = recentHTML;
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Settings
        async function loadSettings() {
            if (systemSettings) {
                document.getElementById('presidentName').value = systemSettings.presidentName || '';
                document.getElementById('certPrefix').value = systemSettings.certPrefix || 'SGS';
                document.getElementById('currentYear').value = systemSettings.currentYear || new Date().getFullYear();
                document.getElementById('logoBase64').value = systemSettings.logoBase64 || '';
            }
        }

        window.saveSettings = async (event) => {
            event.preventDefault();
            
            try {
                await setDoc(doc(db, 'systemSettings', 'config'), {
                    presidentName: document.getElementById('presidentName').value,
                    certPrefix: document.getElementById('certPrefix').value,
                    currentYear: parseInt(document.getElementById('currentYear').value),
                    logoBase64: document.getElementById('logoBase64').value,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                
                alert('Settings saved successfully!');
                await loadSystemSettings();
                
            } catch (error) {
                alert('Error saving settings: ' + error.message);
            }
        };

        // View Certificate (placeholder - you'll need to integrate your existing certificate view)
        window.viewCertificate = (certId) => {
            alert('Certificate viewer will open here. Certificate ID: ' + certId);
            // TODO: Integrate your existing certificate viewing modal
        };

        // Auth Functions
        window.signInWithGoogle = async () => {
            try {
                await signInWithPopup(auth, googleProvider);
            } catch (error) {
                document.getElementById('authMessage').innerHTML = `<div class="alert alert-error">Google sign-in failed: ${error.message}</div>`;
            }
        };

        window.signInWithEmail = async (event) => {
            event.preventDefault();
            const email = document.getElementById('signInEmail').value;
            const password = document.getElementById('signInPassword').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                document.getElementById('authMessage').innerHTML = `<div class="alert alert-error">Sign-in failed: ${error.message}</div>`;
            }
        };

        window.signOut = async () => {
            try {
                await firebaseSignOut(auth);
            } catch (error) {
                console.error('Sign-out error:', error);
            }
        };

        // Initialize
        (async () => {
            await loadSystemSettings();
        })();

        // Auth State Observer
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            
            const authView = document.getElementById('authView');
            const mainApp = document.getElementById('mainApp');
            const headerUserInfo = document.getElementById('headerUserInfo');
            
            if (user) {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                if (userDoc.exists()) {
                    currentUserProfile = userDoc.data();
                } else {
                    currentUserProfile = {
                        name: user.displayName || user.email.split('@')[0],
                        email: user.email,
                        role: 'participant',
                        createdAt: serverTimestamp()
                    };
                    await setDoc(doc(db, 'users', user.uid), currentUserProfile);
                }
                
                document.getElementById('headerUserName').textContent = currentUserProfile.name;
                document.getElementById('headerUserRole').textContent = currentUserProfile.role.toUpperCase();
                headerUserInfo.classList.remove('hidden');
                
                authView.classList.add('hidden');
                mainApp.classList.remove('hidden');
                
                // Initialize navigation based on role
                initializeNavigation(currentUserProfile.role);
                
                // Load initial page
                if (currentUserProfile.role === 'participant') {
                    navigateTo('my-certs');
                } else {
                    loadDashboard();
                }
                
            } else {
                headerUserInfo.classList.add('hidden');
                authView.classList.remove('hidden');
                mainApp.classList.add('hidden');
                currentUserProfile = null;
            }
        });
    </script>
</body>
</html>
