<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Singapore Sketchers Certification System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-details {
            text-align: right;
        }
        
        .user-details .name {
            font-weight: bold;
        }
        
        .user-details .role {
            font-size: 12px;
            opacity: 0.9;
        }
        
        /* Container Styles */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* Dashboard Styles */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .dashboard-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .dashboard-card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-secondary {
            background: #48bb78;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #38a169;
        }
        
        .btn-danger {
            background: #e53e3e;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c53030;
        }
        
        .btn-google {
            background: white;
            color: #333;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }
        
        .btn-google:hover {
            background: #f8f8f8;
            border-color: #4285f4;
        }
        
        /* Certificate List Styles */
        .certificate-list {
            display: grid;
            gap: 15px;
        }
        
        .certificate-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .certificate-item h3 {
            color: #333;
            margin-bottom: 8px;
            font-size: 18px;
        }
        
        .certificate-item .details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .certificate-item .cert-number {
            font-family: monospace;
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }
        
        /* User Management Table */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .user-table th, .user-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .user-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
            font-size: 14px;
        }
        
        .user-table td {
            font-size: 14px;
        }
        
        .role-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .role-superadmin {
            background: #f56565;
            color: white;
        }
        
        .role-admin {
            background: #ed8936;
            color: white;
        }
        
        .role-participant {
            background: #48bb78;
            color: white;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .divider {
            text-align: center;
            margin: 20px 0;
            color: #666;
            position: relative;
        }
        
        .divider::before, .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 45%;
            height: 1px;
            background: #ddd;
        }
        
        .divider::before {
            left: 0;
        }
        
        .divider::after {
            right: 0;
        }
        
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
        }
        
        .stat-card .label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .link-text {
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
        }

        .link-text:hover {
            color: #5a67d8;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1>ðŸŽ¨ Singapore Sketchers Certification System</h1>
            <div id="headerUserInfo" class="user-info hidden">
                <div class="user-details">
                    <div class="name" id="headerUserName">Loading...</div>
                    <div class="role" id="headerUserRole">Loading...</div>
                </div>
                <button class="btn-danger" onclick="signOut()">Sign Out</button>
            </div>
        </div>
    </header>

    <!-- Auth View -->
    <div id="authView" class="hidden">
        <div class="auth-container">
            <h2 style="text-align: center; margin-bottom: 20px;">Sign In</h2>
            
            <button class="btn-google" onclick="signInWithGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" height="18">
                Sign in with Google
            </button>
            
            <div class="divider">OR</div>
            
            <form id="emailSignInForm" onsubmit="signInWithEmail(event)">
                <div class="form-group">
                    <input type="email" id="signInEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="signInPassword" placeholder="Password" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Sign In</button>
                <p style="margin-top: 15px; text-align: center;">
                    <span class="link-text" onclick="toggleSignUp()">Need an account? Sign up</span>
                </p>
            </form>

            <form id="signUpForm" class="hidden" onsubmit="signUpWithEmail(event)">
                <div class="form-group">
                    <input type="text" id="signUpName" placeholder="Full Name" required>
                </div>
                <div class="form-group">
                    <input type="email" id="signUpEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="signUpPassword" placeholder="Password (min 6 characters)" minlength="6" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">Create Account</button>
                <p style="margin-top: 15px; text-align: center;">
                    <span class="link-text" onclick="toggleSignUp()">Back to sign in</span>
                </p>
            </form>
            
            <div id="authMessage" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Main Dashboard View -->
    <div id="dashboardView" class="hidden">
        <div class="container">
            <!-- Stats Section (for admins) -->
            <div id="statsSection" class="stats-grid hidden">
                <div class="stat-card">
                    <div class="number" id="totalCertsCount">0</div>
                    <div class="label">Total Certificates</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="totalUsersCount">0</div>
                    <div class="label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="thisMonthCount">0</div>
                    <div class="label">This Month</div>
                </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard">
                <!-- User Management (Super Admin Only) -->
                <div id="userManagementCard" class="dashboard-card hidden">
                    <h2>User Management</h2>
                    <button class="btn-secondary" onclick="loadUsers()">Refresh Users</button>
                    <div id="usersList" style="margin-top: 15px;">
                        <p>Loading users...</p>
                    </div>
                </div>

                <!-- Issue Certificate (Admin & Super Admin) -->
                <div id="issueCertificateCard" class="dashboard-card hidden">
                    <h2>Issue Certificate</h2>
                    <form id="issueCertForm" onsubmit="issueCertificate(event)">
                        <div class="form-group">
                            <label>Recipient Email *</label>
                            <input type="email" id="certRecipientEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Certificate Type *</label>
                            <select id="certType" required onchange="updateCPDField()">
                                <option value="">Select Type</option>
                                <option value="committee">Committee Member</option>
                                <option value="training-beginner">Training - Beginner</option>
                                <option value="training-intermediate">Training - Intermediate</option>
                                <option value="training-advanced">Training - Advanced</option>
                                <option value="trainer">Trainer</option>
                                <option value="volunteer">Volunteer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Course/Role/Event Title *</label>
                            <input type="text" id="certTitle" required placeholder="e.g., Urban Sketching Workshop">
                        </div>
                        <div class="form-group">
                            <label>CPD Hours</label>
                            <input type="text" id="certHours" placeholder="e.g., 8 or NA">
                        </div>
                        <div class="form-group">
                            <label>Instructor Name (if applicable)</label>
                            <input type="text" id="certInstructor" placeholder="Leave blank if not applicable">
                        </div>
                        <button type="submit" class="btn-primary">Issue Certificate</button>
                    </form>
                    <div id="certMessage" style="margin-top: 15px;"></div>
                </div>

                <!-- My Certificates (Participants) -->
                <div id="myCertificatesCard" class="dashboard-card hidden">
                    <h2>My Certificates</h2>
                    <div id="myCertificatesList">
                        <p>Loading certificates...</p>
                    </div>
                </div>

                <!-- All Certificates (Admin View) -->
                <div id="allCertificatesCard" class="dashboard-card hidden">
                    <h2>Recent Certificates</h2>
                    <div id="allCertificatesList">
                        <p>Loading certificates...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Role Edit Modal -->
    <div id="roleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit User Role</h2>
                <button class="close-btn" onclick="closeRoleModal()">&times;</button>
            </div>
            <form id="roleForm" onsubmit="updateUserRole(event)">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>User Email</label>
                    <input type="text" id="editUserEmail" readonly>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="editUserRole" required>
                        <option value="participant">Participant</option>
                        <option value="admin">Admin</option>
                        <option value="superadmin">Super Admin</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Update Role</button>
            </form>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            signInWithPopup,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            GoogleAuthProvider,
            onAuthStateChanged,
            signOut as firebaseSignOut
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            getDoc,
            getDocs,
            setDoc,
            updateDoc,
            collection,
            addDoc,
            query,
            where,
            orderBy,
            limit,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBsSi4gFWV8VX9kuq0mJmHtTgnR0VXyQ4k",
            authDomain: "sg-sketchers-certs.firebaseapp.com",
            projectId: "sg-sketchers-certs",
            storageBucket: "sg-sketchers-certs.firebasestorage.app",
            messagingSenderId: "506191422278",
            appId: "1:506191422278:web:55bc1d0ff90a966285bb47"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // Global variables
        let currentUser = null;
        let currentUserProfile = null;

        // Auth Functions
        window.signInWithGoogle = async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                showAuthMessage('Signing in...', 'success');
            } catch (error) {
                showAuthMessage('Google sign-in failed: ' + error.message, 'error');
            }
        };

        window.signInWithEmail = async (event) => {
            event.preventDefault();
            const email = document.getElementById('signInEmail').value;
            const password = document.getElementById('signInPassword').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showAuthMessage('Signing in...', 'success');
            } catch (error) {
                showAuthMessage('Sign-in failed: ' + error.message, 'error');
            }
        };

        window.signUpWithEmail = async (event) => {
            event.preventDefault();
            const name = document.getElementById('signUpName').value;
            const email = document.getElementById('signUpEmail').value;
            const password = document.getElementById('signUpPassword').value;
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, 'users', userCredential.user.uid), {
                    name: name,
                    email: email,
                    role: 'participant',
                    createdAt: serverTimestamp()
                });
                showAuthMessage('Account created successfully!', 'success');
            } catch (error) {
                showAuthMessage('Sign-up failed: ' + error.message, 'error');
            }
        };

        window.toggleSignUp = () => {
            const signInForm = document.getElementById('emailSignInForm');
            const signUpForm = document.getElementById('signUpForm');
            signInForm.classList.toggle('hidden');
            signUpForm.classList.toggle('hidden');
            
            // Clear any messages
            document.getElementById('authMessage').innerHTML = '';
        };

        window.signOut = async () => {
            try {
                await firebaseSignOut(auth);
            } catch (error) {
                console.error('Sign-out error:', error);
            }
        };

        // Certificate Functions
        window.issueCertificate = async (event) => {
            event.preventDefault();
            const messageDiv = document.getElementById('certMessage');
            
            try {
                const recipientEmail = document.getElementById('certRecipientEmail').value;
                const certType = document.getElementById('certType').value;
                const certTitle = document.getElementById('certTitle').value;
                const certHours = document.getElementById('certHours').value || 'NA';
                const certInstructor = document.getElementById('certInstructor').value || '';
                
                // Find recipient user
                const usersQuery = query(collection(db, 'users'), where('email', '==', recipientEmail));
                const userSnapshot = await getDocs(usersQuery);
                
                if (userSnapshot.empty) {
                    throw new Error('Recipient not found. User must have an account first.');
                }
                
                const recipientDoc = userSnapshot.docs[0];
                const recipientData = recipientDoc.data();
                
                // Generate certificate number
                const year = new Date().getFullYear();
                const random = Math.random().toString(36).substring(2, 8).toUpperCase();
                const certNumber = `SGS-${year}-${random}`;
                
                // Create certificate
                await addDoc(collection(db, 'certificates'), {
                    recipientId: recipientDoc.id,
                    recipientEmail: recipientEmail,
                    recipientName: recipientData.name || 'Unknown',
                    certificateNumber: certNumber,
                    type: certType,
                    title: certTitle,
                    hours: certHours,
                    instructor: certInstructor,
                    issuedBy: currentUserProfile.name,
                    issuedByEmail: currentUser.email,
                    issuedDate: serverTimestamp(),
                    createdAt: serverTimestamp(),
                    year: year
                });
                
                showCertMessage('Certificate issued successfully! Certificate #: ' + certNumber, 'success');
                document.getElementById('issueCertForm').reset();
                
                // Reload certificates if admin
                if (currentUserProfile.role === 'admin' || currentUserProfile.role === 'superadmin') {
                    loadAllCertificates();
                    loadStats();
                }
                
            } catch (error) {
                showCertMessage('Error: ' + error.message, 'error');
            }
        };

        window.updateCPDField = () => {
            const certType = document.getElementById('certType').value;
            const hoursField = document.getElementById('certHours');
            
            if (certType === 'committee') {
                hoursField.value = 'NA';
            } else {
                hoursField.value = '';
            }
        };

        // User Management Functions
        window.loadUsers = async () => {
            if (currentUserProfile?.role !== 'superadmin') return;
            
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '<p>Loading...</p>';
            
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                let html = '<table class="user-table"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr></thead><tbody>';
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const roleClass = `role-${user.role || 'participant'}`;
                    html += `
                        <tr>
                            <td>${user.name || 'Unknown'}</td>
                            <td>${user.email}</td>
                            <td><span class="role-badge ${roleClass}">${user.role || 'participant'}</span></td>
                            <td><button class="btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="openRoleModal('${doc.id}', '${user.email}', '${user.role || 'participant'}')">Edit</button></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                usersList.innerHTML = html;
                
            } catch (error) {
                usersList.innerHTML = '<p class="alert alert-error">Error loading users</p>';
            }
        };

        window.openRoleModal = (userId, email, currentRole) => {
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUserEmail').value = email;
            document.getElementById('editUserRole').value = currentRole;
            document.getElementById('roleModal').classList.add('active');
        };

        window.closeRoleModal = () => {
            document.getElementById('roleModal').classList.remove('active');
        };

        window.updateUserRole = async (event) => {
            event.preventDefault();
            const userId = document.getElementById('editUserId').value;
            const newRole = document.getElementById('editUserRole').value;
            
            try {
                await updateDoc(doc(db, 'users', userId), {
                    role: newRole
                });
                closeRoleModal();
                loadUsers();
                alert('Role updated successfully!');
            } catch (error) {
                alert('Error updating role: ' + error.message);
            }
        };

        // Load Certificates Functions
        async function loadMyCertificates() {
            const listDiv = document.getElementById('myCertificatesList');
            listDiv.innerHTML = '<p>Loading...</p>';
            
            try {
                const q = query(
                    collection(db, 'certificates'),
                    where('recipientId', '==', currentUser.uid),
                    orderBy('createdAt', 'desc'),
                    limit(10)
                );
                
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    listDiv.innerHTML = '<p>No certificates yet.</p>';
                    return;
                }
                
                let html = '<div class="certificate-list">';
                snapshot.forEach(doc => {
                    const cert = doc.data();
                    const date = cert.issuedDate?.toDate ? cert.issuedDate.toDate().toLocaleDateString() : 'Recent';
                    html += `
                        <div class="certificate-item">
                            <h3>${cert.title}</h3>
                            <div class="details">
                                <div><strong>Type:</strong> ${cert.type}</div>
                                <div><strong>Hours:</strong> ${cert.hours}</div>
                                <div><strong>Issued:</strong> ${date}</div>
                                <div><strong>Certificate #:</strong> <span class="cert-number">${cert.certificateNumber}</span></div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                listDiv.innerHTML = html;
                
            } catch (error) {
                listDiv.innerHTML = '<p class="alert alert-error">Error loading certificates</p>';
            }
        }

        async function loadAllCertificates() {
            const listDiv = document.getElementById('allCertificatesList');
            listDiv.innerHTML = '<p>Loading...</p>';
            
            try {
                const q = query(
                    collection(db, 'certificates'),
                    orderBy('createdAt', 'desc'),
                    limit(20)
                );
                
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    listDiv.innerHTML = '<p>No certificates issued yet.</p>';
                    return;
                }
                
                let html = '<div class="certificate-list">';
                snapshot.forEach(doc => {
                    const cert = doc.data();
                    const date = cert.issuedDate?.toDate ? cert.issuedDate.toDate().toLocaleDateString() : 'Recent';
                    html += `
                        <div class="certificate-item">
                            <h3>${cert.title}</h3>
                            <div class="details">
                                <div><strong>Recipient:</strong> ${cert.recipientName}</div>
                                <div><strong>Type:</strong> ${cert.type}</div>
                                <div><strong>Issued:</strong> ${date}</div>
                                <div><strong>Certificate #:</strong> <span class="cert-number">${cert.certificateNumber}</span></div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                listDiv.innerHTML = html;
                
            } catch (error) {
                listDiv.innerHTML = '<p class="alert alert-error">Error loading certificates</p>';
            }
        }

        async function loadStats() {
            try {
                // Total certificates
                const certsSnapshot = await getDocs(collection(db, 'certificates'));
                document.getElementById('totalCertsCount').textContent = certsSnapshot.size;
                
                // Total users
                const usersSnapshot = await getDocs(collection(db, 'users'));
                document.getElementById('totalUsersCount').textContent = usersSnapshot.size;
                
                // This month's certificates
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                let monthCount = 0;
                certsSnapshot.forEach(doc => {
                    const cert = doc.data();
                    if (cert.createdAt && cert.createdAt.toDate && cert.createdAt.toDate() >= firstDay) {
                        monthCount++;
                    }
                });
                document.getElementById('thisMonthCount').textContent = monthCount;
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Helper Functions
        function showAuthMessage(message, type) {
            const messageDiv = document.getElementById('authMessage');
            messageDiv.className = type === 'error' ? 'alert alert-error' : 'alert alert-success';
            messageDiv.textContent = message;
        }

        function showCertMessage(message, type) {
            const messageDiv = document.getElementById('certMessage');
            messageDiv.className = type === 'error' ? 'alert alert-error' : 'alert alert-success';
            messageDiv.textContent = message;
        }

        // Auth State Observer
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            
            const authView = document.getElementById('authView');
            const dashboardView = document.getElementById('dashboardView');
            const headerUserInfo = document.getElementById('headerUserInfo');
            
            if (user) {
                // Get user profile
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                if (userDoc.exists()) {
                    currentUserProfile = userDoc.data();
                } else {
                    // Create profile for new users (Google sign-in)
                    currentUserProfile = {
                        name: user.displayName || user.email.split('@')[0],
                        email: user.email,
                        role: 'participant',
                        createdAt: serverTimestamp()
                    };
                    await setDoc(doc(db, 'users', user.uid), currentUserProfile);
                }
                
                // Update header
                document.getElementById('headerUserName').textContent = currentUserProfile.name;
                document.getElementById('headerUserRole').textContent = currentUserProfile.role.toUpperCase();
                headerUserInfo.classList.remove('hidden');
                
                // Show dashboard
                authView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                
                // Show/hide cards based on role
                const role = currentUserProfile.role;
                
                if (role === 'superadmin') {
                    document.getElementById('userManagementCard').classList.remove('hidden');
                    document.getElementById('issueCertificateCard').classList.remove('hidden');
                    document.getElementById('allCertificatesCard').classList.remove('hidden');
                    document.getElementById('statsSection').classList.remove('hidden');
                    document.getElementById('myCertificatesCard').classList.add('hidden');
                    loadUsers();
                    loadAllCertificates();
                    loadStats();
                } else if (role === 'admin') {
                    document.getElementById('userManagementCard').classList.add('hidden');
                    document.getElementById('issueCertificateCard').classList.remove('hidden');
                    document.getElementById('allCertificatesCard').classList.remove('hidden');
                    document.getElementById('statsSection').classList.remove('hidden');
                    document.getElementById('myCertificatesCard').classList.add('hidden');
                    loadAllCertificates();
                    loadStats();
                } else {
                    document.getElementById('userManagementCard').classList.add('hidden');
                    document.getElementById('issueCertificateCard').classList.add('hidden');
                    document.getElementById('allCertificatesCard').classList.add('hidden');
                    document.getElementById('statsSection').classList.add('hidden');
                    document.getElementById('myCertificatesCard').classList.remove('hidden');
                    loadMyCertificates();
                }
                
            } else {
                // Show auth view
                headerUserInfo.classList.add('hidden');
                authView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
                currentUserProfile = null;
            }
        });
    </script>
</body>
</html>
